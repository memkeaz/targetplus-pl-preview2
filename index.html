<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Target Plus P&L — CSV + API + Charts + COGS (No-React)</title>
    <style>
      :root{
        --bg:#0b0c10; --card:#121319; --text:#eaf0f6; --muted:#9aa4b2; --accent:#4da3ff; --positive:#2fd37e; --negative:#ff6b6b; --table:#171821;
      }
      *{box-sizing:border-box}
      body{margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--text)}
      .header{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:18px 22px; border-bottom:1px solid #1f2130; flex-wrap:wrap}
      .logo{font-weight:700; letter-spacing:.3px}
      .container{padding:22px; max-width:1300px; margin:0 auto}
      .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:18px}
      .card{background:var(--card); border:1px solid #1f2130; border-radius:12px; padding:16px}
      .kpi .label{color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.08em}
      .kpi .value{font-size:24px; font-weight:700}
      .controls{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
      .input, .select{background:#0f1017; border:1px solid #25283a; color:var(--text); padding:10px 12px; border-radius:10px}
      .number{width:120px}
      .date{width:170px}
      .button{background:var(--accent); color:#06203a; font-weight:700; border:none; padding:10px 14px; border-radius:10px; cursor:pointer}
      table{width:100%; border-collapse:separate; border-spacing:0; background:var(--table); border:1px solid #1f2130; border-radius:12px; overflow:hidden}
      th, td{padding:12px 14px; text-align:left; border-bottom:1px solid #1f2130; font-size:14px}
      th{color:var(--muted); cursor:pointer; user-select:none; white-space:nowrap}
      tr:hover td{background:#151726}
      .footer{display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:12px; padding-top:8px}
      .pill{padding:4px 8px; border:1px solid #2a3653; border-radius:999px; color:#a9b4c7}
      .warn{color:#ffb86b}
      .ok{color:var(--positive)}
      .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
      .section-title{font-size:14px; color:var(--muted); margin-bottom:8px; text-transform:uppercase; letter-spacing:.1em}
      .modal{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; padding:20px}
      .modal .panel{background:#0f1017; border:1px solid #25283a; border-radius:12px; width:min(900px, 95vw); max-height:90vh; overflow:auto; padding:18px}
      .modal .panel h3{margin:0 0 10px 0}
      .modal .panel label{display:block; font-size:12px; color:var(--muted); margin-top:10px}
      .modal .panel input, .modal .panel textarea{width:100%; background:#0b0c14; color:var(--text); border:1px solid #2a2f45; border-radius:10px; padding:10px}
      .modal .panel textarea{min-height:160px}
      .modal .panel .actions{display:flex; gap:10px; justify-content:flex-end; margin-top:12px}
      .link{background:transparent; border:1px solid #2a3653; color:#a9b4c7; padding:8px 12px; border-radius:10px; cursor:pointer}
      canvas{background:#0f1017; border:1px solid #1f2130; border-radius:12px; padding:8px}
    </style>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="header">
      <div class="logo">Target Plus P&L — CSV + API + Charts + COGS</div>
      <div class="controls">
        <input id="csvFile" type="file" accept=".csv,text/csv" class="input" />
        <label>Default Fee % <input id="feePct" type="number" class="input number" step="0.01" min="0" max="0.5" value="0.12"></label>
        <label>From <input id="dateFrom" type="date" class="input date"></label>
        <label>To <input id="dateTo" type="date" class="input date"></label>
        <button id="applyDates" class="button">Apply Dates</button>
        <button id="downloadBtn" class="link" title="Download the current By-SKU table as CSV">Download CSV</button>
        <button id="openSettings" class="link">API Settings</button>
        <button id="openCogs" class="link">COGS Editor</button>
        <span id="status" class="pill">Waiting for CSV / API…</span>
      </div>
    </div>

    <div class="container">
      <div class="grid" style="margin-bottom:12px">
        <div class="card kpi" style="grid-column:span 3">
          <div class="label">Revenue</div>
          <div class="value" id="kpiRevenue">$0.00</div>
        </div>
        <div class="card kpi" style="grid-column:span 3">
          <div className="label">Refunds</div>
          <div class="value" id="kpiRefunds">$0.00</div>
        </div>
        <div class="card kpi" style="grid-column:span 3">
          <div class="label">Fees</div>
          <div class="value" id="kpiFees">$0.00</div>
        </div>
        <div class="card kpi" style="grid-column:span 3">
          <div class="label">Gross Profit</div>
          <div class="value" id="kpiGP">$0.00</div>
        </div>
      </div>

      <div class="grid" style="margin-bottom:12px">
        <div class="card" style="grid-column:span 8">
          <div class="section-title">Revenue & Gross Profit over time</div>
          <canvas id="timeChart" height="120"></canvas>
        </div>
        <div class="card" style="grid-column:span 4">
          <div class="section-title">Top SKUs by Gross Profit</div>
          <canvas id="skuPie" height="120"></canvas>
        </div>
      </div>

      <div class="card" style="margin-bottom:12px">
        <div class="row">
          <div style="flex:1">
            <label style="color:var(--muted); font-size:12px;">Product</label><br/>
            <select id="skuSelect" class="select"></select>
          </div>
          <div style="flex:2">
            <label style="color:var(--muted); font-size:12px;">Search (SKU/Title)</label><br/>
            <input id="searchInput" class="input" placeholder="Type to filter…" style="width:100%" />
          </div>
          <div>
            <button id="resetBtn" class="button">Reset</button>
          </div>
          <div id="columnsHint" class="warn" style="margin-left:auto"></div>
        </div>
      </div>

      <div class="card">
        <table id="tbl">
          <thead>
            <tr id="tblHead"></tr>
          </thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>

      <div class="footer">
        <div>Tip: Include <code>marketplace_fee</code> and <code>cogs</code> columns in your CSV for most accurate margins. Missing fees are estimated using Default Fee %.</div>
        <div id="rowsCount" class="pill">0 rows</div>
      </div>
    </div>

    <!-- Modal: API settings -->
    <div id="settingsModal" class="modal">
      <div class="panel">
        <h3>Target Plus API Settings</h3>
        <p style="color:var(--muted)">
          This is a static page. Live API calls may be blocked by CORS unless your Target Plus endpoint allows it.
          If Fetch fails, paste the JSON response below (from Postman/Insomnia) and click <b>Import JSON</b>.
        </p>
        <label>Base URL</label>
        <input id="apiBase" placeholder="e.g., https://plus.target.com" />
        <label>API Token</label>
        <input id="apiToken" placeholder="Bearer token" />
        <label>Seller / SMS ID</label>
        <input id="apiSeller" placeholder="Your Seller ID" />
        <div class="row">
          <button id="saveApi" class="link">Save</button>
          <button id="fetchOrders" class="button">Fetch Last 100 Orders</button>
          <span id="apiStatus" class="pill">Idle</span>
        </div>
        <label>Or paste orders JSON</label>
        <textarea id="apiJson" placeholder='{"orders":[ ... ]}'></textarea>
        <div class="actions">
          <button class="link" id="closeSettings">Close</button>
          <button class="button" id="importJson">Import JSON</button>
        </div>
      </div>
    </div>

    <!-- Modal: COGS editor -->
    <div id="cogsModal" class="modal">
      <div class="panel">
        <h3>COGS Editor</h3>
        <p style="color:var(--muted)">Set per-SKU COGS (saved in your browser).</p>
        <div class="row">
          <select id="cogsSku" class="select"></select>
          <input id="cogsValue" type="number" class="input number" step="0.01" min="0" placeholder="COGS per unit" />
          <button id="saveCogs" class="button">Save COGS</button>
          <span id="cogsStatus" class="pill">Idle</span>
        </div>
        <div style="margin-top:10px; font-size:12px; color:var(--muted)">Tip: COGS overrides apply to all rows for that SKU (CSV + API). They are stored in <code>localStorage</code> and persist on this browser.</div>
        <div class="actions">
          <button class="link" id="closeCogs">Close</button>
        </div>
      </div>
    </div>

    <script>
      // --- Utilities & storage ---
      const $ = sel => document.querySelector(sel);
      const fmtUSD = n => (n||0).toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:2});
      const dParse = s => { const dt = new Date(s); return isNaN(dt.getTime()) ? null : dt; };
      const dKey = dt => dt.toISOString().slice(0,10);
      const ls = {
        get(k, d){ try{ const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch(e){ return d; } },
        set(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
      };

      // Tiny CSV parser
      function parseCSV(text){
        const rows = [];
        let row = [], field = "", i = 0, inQuotes = false;
        while (i < text.length){
          const c = text[i];
          if (inQuotes){
            if (c === '"'){ if (text[i+1] === '"'){ field += '"'; i++; } else { inQuotes = false; } }
            else { field += c; }
          } else {
            if (c === '"'){ inQuotes = true; }
            else if (c === ','){ row.push(field); field = ""; }
            else if (c === '\n'){ rows.push(row.concat(field)); row = []; field = ""; }
            else if (c === '\r'){}
            else { field += c; }
          }
          i++;
        }
        if (field.length || row.length) rows.push(row.concat(field));
        return rows;
      }
      const toLowerMap = arr => Object.fromEntries(arr.map((h,i)=>[h.trim().toLowerCase(), i]));
      const num = v => { if (v==null || v==="") return 0; const n = Number(String(v).replace(/[^0-9.\-]/g,"")); return isNaN(n) ? 0 : n; };
      const str = v => (v==null ? "" : String(v));

      // Local storage keys
      const LS_API = "tp_api";
      const LS_FEE = "tp_fee_pct";
      const LS_COGS = "tp_cogs_overrides";

      // --- Data normalization ---
      function normalizeCsvRows(rows, feePct, cogsOverrides){
        const [head, ...rest] = rows;
        if (!head) return [];
        const cols = toLowerMap(head);
        showColumnsHint(cols);

        const out = [];
        rest.forEach(arr => {
          if (!arr || !arr.length) return;
          const get = name => {
            const i = cols[name];
            return (typeof i === "number") ? arr[i] : "";
          };
          const quantity = num(get("quantity")||1);
          const price = num(get("item_price"));
          const feeCol = get("marketplace_fee");
          const fee = feeCol !== "" ? num(feeCol) : +(price * quantity * feePct).toFixed(2);
          const sku = str(get("sku"));
          const cogsCsv = num(get("cogs"));
          const cogs = (cogsOverrides && sku in cogsOverrides) ? Number(cogsOverrides[sku]) : cogsCsv;
          out.push({
            source: "csv",
            order_id: str(get("order_id")),
            purchase_date: str(get("purchase_date")),
            sku,
            title: str(get("title")),
            quantity: quantity,
            item_price: price,
            shipping_price: num(get("shipping_price")),
            tax: num(get("tax")),
            refund_amount: num(get("refund_amount")),
            buyer_state: str(get("buyer_state")),
            marketplace_fee: fee,
            cogs: cogs
          });
        });
        return out;
      }

      function flattenOrderJson(o, cogsOverrides){
        const order_id = o.order_id || o.id || o.orderNumber || o.order_number;
        const purchase_date = o.purchase_date || o.createdAt || o.created_at;
        const buyer_state = (o.shipping_address && (o.shipping_address.state || o.shipping_address.region)) || o.buyer_state;
        const status = o.status || "Shipped";
        const lines = Array.isArray(o.lines) ? o.lines : (Array.isArray(o.order_lines) ? o.order_lines : []);
        const rows = lines.map(li => {
          const sku = li.sku || li.sellerSku || li.SKU || "";
          const cogsLi = num(li.cogs ?? 0);
          const cogs = (cogsOverrides && sku in cogsOverrides) ? Number(cogsOverrides[sku]) : cogsLi;
          return {
            source: "api",
            order_id,
            purchase_date,
            sku,
            title: li.title || li.name || "",
            quantity: Number(li.quantity || 1),
            item_price: num(li.item_price ?? li.price ?? 0),
            shipping_price: num(li.shipping_price ?? 0),
            tax: num(li.tax ?? 0),
            refund_amount: num(li.refund_amount ?? 0),
            buyer_state,
            marketplace_fee: num(li.marketplace_fee ?? 0),
            cogs,
            status
          };
        });
        return rows;
      }

      function normalizeApiPayload(payload, cogsOverrides){
        let orders = payload.orders || payload.data || payload;
        if (!Array.isArray(orders)) orders = [orders];
        const out = [];
        orders.forEach(o => { out.push(...flattenOrderJson(o, cogsOverrides)); });
        return out;
      }

      // Aggregations
      function groupBySku(rows){
        const map = new Map();
        rows.forEach(r => {
          const key = r.sku;
          const cur = map.get(key) || { sku:key, title:r.title, units:0, revenue:0, refunds:0, fees:0, cogsTotal:0 };
          cur.units += (r.quantity||0);
          cur.revenue += (r.item_price||0) * (r.quantity||0);
          cur.refunds += (r.refund_amount||0);
          cur.fees += (r.marketplace_fee||0);
          cur.cogsTotal += (r.cogs||0) * (r.quantity||0);
          map.set(key, cur);
        });
        return Array.from(map.values()).map(x => {
          const net = x.revenue - x.refunds;
          const gp = net - x.fees - x.cogsTotal;
          const margin = net ? (gp / net) * 100 : 0;
          return { ...x, grossProfit: gp, margin };
        });
      }

      function totals(rows){
        const revenue = rows.reduce((s,r)=>s+r.revenue,0);
        const refunds = rows.reduce((s,r)=>s+r.refunds,0);
        const fees = rows.reduce((s,r)=>s+r.fees,0);
        const cogs = rows.reduce((s,r)=>s+r.cogsTotal,0);
        const net = revenue - refunds;
        const gp = net - fees - cogs;
        const margin = net ? (gp / net) * 100 : 0;
        return { revenue, refunds, fees, cogs, gp, margin };
      }

      function groupByDate(rows){
        const byDate = new Map();
        rows.forEach(r => {
          const dt = dParse(r.purchase_date);
          if (!dt) return;
          const key = dKey(dt);
          const cur = byDate.get(key) || { revenue:0, refunds:0, fees:0, cogs:0 };
          cur.revenue += (r.item_price||0) * (r.quantity||0);
          cur.refunds += (r.refund_amount||0);
          cur.fees += (r.marketplace_fee||0);
          cur.cogs += (r.cogs||0) * (r.quantity||0);
          byDate.set(key, cur);
        });
        const arr = Array.from(byDate.entries()).map(([date, v]) => {
          const net = v.revenue - v.refunds;
          const gp = net - v.fees - v.cogs;
          return { date, revenue:v.revenue, gp };
        }).sort((a,b)=>a.date.localeCompare(b.date));
        return arr;
      }

      // --- State ---
      let allLines = [];   // raw normalized lines (csv+api)
      let filteredLines = []; // lines after date filtering
      let bySku = [];      // aggregated
      let sortKey = "grossProfit";
      let sortDir = "desc";
      let productFilter = "";
      let searchQ = "";
      let chartTime, chartPie;
      let cogsOverrides = ls.get(LS_COGS, {});

      const headers = [
        ["sku","SKU"],
        ["title","Title"],
        ["units","Units"],
        ["revenue","Revenue"],
        ["refunds","Refunds"],
        ["fees","Fees"],
        ["cogsTotal","COGS (total)"],
        ["grossProfit","Gross Profit"],
        ["margin","Margin %"]
      ];

      function renderTable(rows){
        const head = $("#tblHead");
        head.innerHTML = "";
        headers.forEach(([key,label]) => {
          const th = document.createElement("th");
          th.textContent = label + (sortKey===key ? (sortDir==="asc"?" ▲":" ▼") : "");
          th.onclick = () => { if (sortKey===key) sortDir = (sortDir==="asc"?"desc":"asc"); else { sortKey=key; sortDir="asc"; } update(); };
          head.appendChild(th);
        });

        const body = $("#tblBody");
        body.innerHTML = "";
        rows.forEach(r => {
          const tr = document.createElement("tr");
          const cells = [
            r.sku,
            r.title || "—",
            r.units,
            fmtUSD(r.revenue),
            fmtUSD(r.refunds),
            fmtUSD(r.fees),
            fmtUSD(r.cogsTotal),
            fmtUSD(r.grossProfit),
            (r.margin||0).toFixed(2)
          ];
          cells.forEach(val => {
            const td = document.createElement("td");
            td.textContent = val;
            tr.appendChild(td);
          });
          body.appendChild(tr);
        });
        $("#rowsCount").textContent = rows.length + " rows";
      }

      function updateKPIs(t){
        $("#kpiRevenue").textContent = fmtUSD(t.revenue);
        $("#kpiRefunds").textContent = fmtUSD(t.refunds);
        $("#kpiFees").textContent = fmtUSD(t.fees);
        $("#kpiGP").textContent = fmtUSD(t.gp);
      }

      function updateSkuFilter(){
        const sel = $("#skuSelect");
        const skus = Array.from(new Set(filteredLines.map(r=>r.sku))).sort();
        sel.innerHTML = '<option value="">All products</option>' + skus.map(s=>'<option>'+s+'</option>').join("");
        // Also populate COGS editor dropdown
        const csel = $("#cogsSku");
        if (csel){
          csel.innerHTML = skus.map(s=>'<option>'+s+'</option>').join("");
        }
      }

      function filteredSorted(){
        let rows = bySku.filter(r => {
          const okSku = productFilter ? r.sku === productFilter : true;
          const hay = (r.sku + " " + (r.title||"")).toLowerCase();
          const okQ = searchQ ? hay.includes(searchQ.toLowerCase()) : true;
          return okSku && okQ;
        });
        rows.sort((a,b) => {
          const av = a[sortKey], bv = b[sortKey];
          if (av < bv) return sortDir==="asc" ? -1 : 1;
          if (av > bv) return sortDir==="asc" ? 1 : -1;
          return 0;
        });
        return rows;
      }

      function applyDateFilter(){
        const f = $("#dateFrom").value ? new Date($("#dateFrom").value + "T00:00:00") : null;
        const t = $("#dateTo").value ? new Date($("#dateTo").value + "T23:59:59") : null;
        filteredLines = allLines.filter(r => {
          const dt = dParse(r.purchase_date);
          if (!dt) return true;
          if (f && dt < f) return false;
          if (t && dt > t) return false;
          return true;
        });
      }

      function updateCharts(rows){
        const series = groupByDate(filteredLines);
        const labels = series.map(s=>s.date);
        const rev = series.map(s=>+(s.revenue.toFixed(2)));
        const gp = series.map(s=>+(s.gp.toFixed(2)));

        // Time chart
        const ctx1 = document.getElementById('timeChart').getContext('2d');
        if (chartTime) chartTime.destroy();
        chartTime = new Chart(ctx1, {
          type: 'line',
          data: { labels, datasets: [ { label: 'Revenue', data: rev }, { label: 'Gross Profit', data: gp } ] },
          options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } }
        });

        // Pie for top SKUs by GP
        const top = [...rows].sort((a,b)=>b.grossProfit - a.grossProfit).slice(0,6);
        const ctx2 = document.getElementById('skuPie').getContext('2d');
        if (chartPie) chartPie.destroy();
        chartPie = new Chart(ctx2, {
          type: 'pie',
          data: { labels: top.map(r=>r.sku), datasets: [{ data: top.map(r=>+(r.grossProfit.toFixed(2))) }] },
          options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });
      }

      function showColumnsHint(cols){
        const need = ["order_id","purchase_date","sku","title","quantity","item_price","shipping_price","tax","refund_amount","buyer_state"];
        const missing = need.filter(c => !(c in cols));
        $("#columnsHint").textContent = missing.length ? "Missing columns: " + missing.join(", ") + " (we'll still import what we can)" : "All key columns detected";
        $("#columnsHint").className = missing.length ? "warn" : "ok";
      }

      function update(){
        applyDateFilter();
        bySku = groupBySku(filteredLines);
        const rows = filteredSorted();
        renderTable(rows);
        updateKPIs(totals(rows));
        updateSkuFilter();
        updateCharts(rows);
      }

      // --- Event wiring ---
      $("#csvFile").addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        $("#status").textContent = "Reading " + file.name + "…";
        const reader = new FileReader();
        reader.onload = () => {
          try{
            const text = reader.result;
            const rows = parseCSV(text);
            const feePct = Number($("#feePct").value || 0.12);
            const lines = normalizeCsvRows(rows, feePct, cogsOverrides);
            allLines = allLines.concat(lines);
            $("#status").textContent = "Loaded " + file.name + " (" + lines.length + " lines)";
            update();
          }catch(err){
            console.error(err);
            $("#status").textContent = "Error reading file. See console.";
          }
        };
        reader.readAsText(file);
      });

      // fee percent persist
      const savedFee = ls.get(LS_FEE, 0.12);
      $("#feePct").value = savedFee;
      $("#feePct").addEventListener("change", () => {
        const val = Number($("#feePct").value || 0.12);
        ls.set(LS_FEE, val);
        if (!allLines.length) return;
        // recompute estimated fees for rows with zero fee
        allLines = allLines.map(r => ({ ...r, marketplace_fee: r.marketplace_fee ? r.marketplace_fee : +( (r.item_price||0) * (r.quantity||0) * val ).toFixed(2) }));
        update();
      });

      $("#applyDates").addEventListener("click", update);
      $("#skuSelect").addEventListener("change", (e) => { productFilter = e.target.value; update(); });
      $("#searchInput").addEventListener("input", (e) => { searchQ = e.target.value; update(); });
      $("#resetBtn").addEventListener("click", () => {
        $("#skuSelect").value = ""; productFilter = "";
        $("#searchInput").value = ""; searchQ = "";
        sortKey = "grossProfit"; sortDir = "desc";
        $("#dateFrom").value = ""; $("#dateTo").value = "";
        update();
      });

      $("#downloadBtn").addEventListener("click", () => {
        const rows = filteredSorted();
        const cols = ["SKU","Title","Units","Revenue","Refunds","Fees","COGS (total)","Gross Profit","Margin %"];
        const lines = [cols.join(",")].concat(rows.map(r => [
          r.sku, r.title||"", r.units,
          r.revenue.toFixed(2), r.refunds.toFixed(2), r.fees.toFixed(2),
          r.cogsTotal.toFixed(2), r.grossProfit.toFixed(2),
          (r.margin||0).toFixed(2)
        ].join(",")));
        const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = "pnl_by_sku.csv"; a.click();
        URL.revokeObjectURL(url);
      });

      // Modal controls: API
      $("#openSettings").addEventListener("click", ()=> {
        const saved = ls.get(LS_API, {});
        $("#apiBase").value = saved.base || "";
        $("#apiToken").value = saved.token || "";
        $("#apiSeller").value = saved.seller || "";
        $("#settingsModal").style.display = "flex";
      });
      $("#closeSettings").addEventListener("click", ()=> $("#settingsModal").style.display = "none");
      $("#saveApi").addEventListener("click", ()=> {
        ls.set(LS_API, { base: $("#apiBase").value.trim(), token: $("#apiToken").value.trim(), seller: $("#apiSeller").value.trim() });
        $("#apiStatus").textContent = "Saved";
      });

      $("#fetchOrders").addEventListener("click", async () => {
        const base = $("#apiBase").value.trim().replace(/\/$/,"");
        const token = $("#apiToken").value.trim();
        const seller = $("#apiSeller").value.trim();
        if (!base || !token || !seller) { $("#apiStatus").textContent = "Missing fields"; return; }
        $("#apiStatus").textContent = "Fetching…";
        try{
          const url = base + "/seller_orders-v1/orders?seller_id=" + encodeURIComponent(seller) + "&limit=100";
          const resp = await fetch(url, { headers: { "Authorization": "Bearer " + token, "Content-Type":"application/json" } });
          if (!resp.ok) throw new Error("HTTP " + resp.status);
          const json = await resp.json();
          const lines = normalizeApiPayload(json, cogsOverrides);
          allLines = allLines.concat(lines);
          $("#apiStatus").textContent = "Imported " + lines.length + " lines";
          $("#status").textContent = "API import done";
          update();
        }catch(err){
          console.error(err);
          $("#apiStatus").textContent = "Fetch failed (likely CORS). Paste JSON below.";
        }
      });

      $("#importJson").addEventListener("click", () => {
        try{
          const json = JSON.parse($("#apiJson").value || "{}");
          const lines = normalizeApiPayload(json, cogsOverrides);
          allLines = allLines.concat(lines);
          $("#apiStatus").textContent = "Imported " + lines.length + " lines from JSON";
          $("#status").textContent = "JSON import done";
          update();
        }catch(err){
          console.error(err);
          $("#apiStatus").textContent = "Invalid JSON";
        }
      });

      // Modal controls: COGS
      $("#openCogs").addEventListener("click", ()=> {
        updateSkuFilter(); // ensure dropdown up-to-date
        $("#cogsSku").value = $("#cogsSku").options[0] ? $("#cogsSku").options[0].value : "";
        $("#cogsValue").value = $("#cogsSku").value in cogsOverrides ? cogsOverrides[$("#cogsSku").value] : "";
        $("#cogsModal").style.display = "flex";
      });
      $("#closeCogs").addEventListener("click", ()=> $("#cogsModal").style.display = "none");

      $("#cogsSku").addEventListener("change", () => {
        const sku = $("#cogsSku").value;
        $("#cogsValue").value = sku in cogsOverrides ? cogsOverrides[sku] : "";
      });

      $("#saveCogs").addEventListener("click", () => {
        const sku = $("#cogsSku").value;
        const v = Number($("#cogsValue").value || 0);
        if (!sku) { $("#cogsStatus").textContent = "Choose SKU"; return; }
        if (v < 0) { $("#cogsStatus").textContent = "Invalid COGS"; return; }
        cogsOverrides[sku] = v;
        ls.set(LS_COGS, cogsOverrides);
        // apply to all lines for that SKU
        allLines = allLines.map(r => r.sku === sku ? { ...r, cogs: v } : r);
        $("#cogsStatus").textContent = "Saved";
        update();
      });

      // Seed with a small sample
      (function seed(){
        const savedApi = ls.get(LS_API, {});
        if (savedApi.base) $("#status").textContent = "API settings saved (" + savedApi.base + ")";
        const sample = `order_id,purchase_date,sku,title,quantity,item_price,shipping_price,tax,refund_amount,buyer_state,marketplace_fee,cogs
TGT-1001,2025-07-01,ABC-123,Widget A,2,25.00,5.00,3.00,0.00,MN,6.00,8.50
TGT-1001,2025-07-01,XYZ-999,Gadget Z,1,40.00,0.00,2.80,0.00,MN,4.80,18.00
TGT-1002,2025-07-03,ABC-123,Widget A,1,25.00,5.00,2.50,0.00,CA,3.00,8.50
TGT-1003,2025-07-04,LMN-456,Thing Q,3,15.00,0.00,3.38,0.00,NY,5.40,6.00
TGT-1004,2025-07-05,XYZ-999,Gadget Z,1,40.00,0.00,3.20,40.00,TX,4.80,18.00`;
        const rows = parseCSV(sample);
        allLines = normalizeCsvRows(rows, Number(ls.get(LS_FEE, 0.12)), cogsOverrides);
        update();
      })();
    </script>
  </body>
</html>
