<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Target Plus P&L — CSV Upload (No-React)</title>
    <style>
      :root{
        --bg:#0b0c10; --card:#121319; --text:#eaf0f6; --muted:#9aa4b2; --accent:#4da3ff; --positive:#2fd37e; --negative:#ff6b6b; --table:#171821;
      }
      *{box-sizing:border-box}
      body{margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--text)}
      .header{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:18px 22px; border-bottom:1px solid #1f2130; flex-wrap:wrap}
      .logo{font-weight:700; letter-spacing:.3px}
      .container{padding:22px; max-width:1200px; margin:0 auto}
      .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:18px}
      .card{background:var(--card); border:1px solid #1f2130; border-radius:12px; padding:16px}
      .kpi .label{color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.08em}
      .kpi .value{font-size:24px; font-weight:700}
      .controls{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
      .input, .select{background:#0f1017; border:1px solid #25283a; color:var(--text); padding:10px 12px; border-radius:10px}
      .number{width:120px}
      .button{background:var(--accent); color:#06203a; font-weight:700; border:none; padding:10px 14px; border-radius:10px; cursor:pointer}
      table{width:100%; border-collapse:separate; border-spacing:0; background:var(--table); border:1px solid #1f2130; border-radius:12px; overflow:hidden}
      th, td{padding:12px 14px; text-align:left; border-bottom:1px solid #1f2130; font-size:14px}
      th{color:var(--muted); cursor:pointer; user-select:none; white-space:nowrap}
      tr:hover td{background:#151726}
      .footer{display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:12px; padding-top:8px}
      .pill{padding:4px 8px; border:1px solid #2a3653; border-radius:999px; color:#a9b4c7}
      .warn{color:#ffb86b}
      .ok{color:var(--positive)}
    </style>
  </head>
  <body>
    <div class="header">
      <div class="logo">Target Plus P&L — CSV Upload</div>
      <div class="controls">
        <input id="csvFile" type="file" accept=".csv,text/csv" class="input" />
        <label>Default Fee % <input id="feePct" type="number" class="input number" step="0.01" min="0" max="0.5" value="0.12"></label>
        <button id="downloadBtn" class="button" title="Download the current By-SKU table as CSV">Download CSV</button>
        <span id="status" class="pill">Waiting for CSV…</span>
      </div>
    </div>

    <div class="container">
      <div class="grid" style="margin-bottom:12px">
        <div class="card kpi" style="grid-column:span 3">
          <div class="label">Revenue</div>
          <div class="value" id="kpiRevenue">$0.00</div>
        </div>
        <div class="card kpi" style="grid-column:span 3">
          <div class="label">Refunds</div>
          <div class="value" id="kpiRefunds">$0.00</div>
        </div>
        <div class="card kpi" style="grid-column:span 3">
          <div class="label">Fees</div>
          <div class="value" id="kpiFees">$0.00</div>
        </div>
        <div class="card kpi" style="grid-column:span 3">
          <div class="label">Gross Profit</div>
          <div class="value" id="kpiGP">$0.00</div>
        </div>
      </div>

      <div class="card" style="margin-bottom:12px">
        <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:end">
          <div style="flex:1">
            <label style="color:var(--muted); font-size:12px;">Product</label><br/>
            <select id="skuSelect" class="select"></select>
          </div>
          <div style="flex:2">
            <label style="color:var(--muted); font-size:12px;">Search (SKU/Title)</label><br/>
            <input id="searchInput" class="input" placeholder="Type to filter…" style="width:100%" />
          </div>
          <div>
            <button id="resetBtn" class="button">Reset</button>
          </div>
          <div id="columnsHint" class="warn" style="margin-left:auto"></div>
        </div>
      </div>

      <div class="card">
        <table id="tbl">
          <thead>
            <tr id="tblHead"></tr>
          </thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>

      <div class="footer">
        <div>Tip: Include <code>marketplace_fee</code> and <code>cogs</code> columns in your CSV for most accurate margins. Missing fees are estimated using Default Fee %.</div>
        <div id="rowsCount" class="pill">0 rows</div>
      </div>
    </div>

    <script>
      // --- Utilities ---
      const $ = sel => document.querySelector(sel);
      const fmtUSD = n => (n||0).toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:2});

      // Very small CSV parser with quote support
      function parseCSV(text){
        const rows = [];
        let row = [], field = "", i = 0, inQuotes = false;
        while (i < text.length){
          const c = text[i];
          if (inQuotes){
            if (c === '"'){
              if (text[i+1] === '"'){ field += '"'; i++; }
              else { inQuotes = false; }
            } else {
              field += c;
            }
          } else {
            if (c === '"'){ inQuotes = true; }
            else if (c === ','){ row.push(field); field = ""; }
            else if (c === '\n'){ rows.push(row.concat(field)); row = []; field = ""; }
            else if (c === '\r'){ /* ignore CR */ }
            else { field += c; }
          }
          i++;
        }
        if (field.length || row.length) rows.push(row.concat(field));
        return rows;
      }

      function toLowerMap(arr){ const m = {}; arr.forEach((h,i)=> m[h.trim().toLowerCase()] = i); return m; }
      function num(v){ if (v==null || v==="") return 0; const n = Number(String(v).replace(/[^0-9.\-]/g,"")); return isNaN(n)?0:n; }
      function str(v){ return (v==null) ? "" : String(v); }

      function groupBySku(rows){
        const map = new Map();
        rows.forEach(r => {
          const key = r.sku;
          const cur = map.get(key) || { sku:key, title:r.title, units:0, revenue:0, refunds:0, fees:0, cogsTotal:0 };
          cur.units += (r.quantity||0);
          cur.revenue += (r.item_price||0) * (r.quantity||0);
          cur.refunds += (r.refund_amount||0);
          cur.fees += (r.marketplace_fee||0);
          cur.cogsTotal += (r.cogs||0) * (r.quantity||0);
          map.set(key, cur);
        });
        return Array.from(map.values()).map(x => {
          const net = x.revenue - x.refunds;
          const gp = net - x.fees - x.cogsTotal;
          const margin = net ? (gp / net) * 100 : 0;
          return { ...x, grossProfit: gp, margin };
        });
      }

      function computeTotals(bySku){
        const revenue = bySku.reduce((s,r)=>s+r.revenue,0);
        const refunds = bySku.reduce((s,r)=>s+r.refunds,0);
        const fees = bySku.reduce((s,r)=>s+r.fees,0);
        const cogs = bySku.reduce((s,r)=>s+r.cogsTotal,0);
        const net = revenue - refunds;
        const gp = net - fees - cogs;
        const margin = net ? (gp / net) * 100 : 0;
        return { revenue, refunds, fees, cogs, gp, margin };
      }

      // --- State ---
      let allLines = [];   // raw normalized lines
      let bySku = [];      // aggregated
      let sortKey = "grossProfit";
      let sortDir = "desc";
      let productFilter = "";
      let searchQ = "";

      const headers = [
        ["sku","SKU"],
        ["title","Title"],
        ["units","Units"],
        ["revenue","Revenue"],
        ["refunds","Refunds"],
        ["fees","Fees"],
        ["cogsTotal","COGS (total)"],
        ["grossProfit","Gross Profit"],
        ["margin","Margin %"]
      ];

      function renderTable(rows){
        const head = $("#tblHead");
        head.innerHTML = "";
        headers.forEach(([key,label]) => {
          const th = document.createElement("th");
          th.textContent = label + (sortKey===key ? (sortDir==="asc"?" ▲":" ▼") : "");
          th.onclick = () => { if (sortKey===key) sortDir = (sortDir==="asc"?"desc":"asc"); else { sortKey=key; sortDir="asc"; } update(); };
          head.appendChild(th);
        });

        const body = $("#tblBody");
        body.innerHTML = "";
        rows.forEach(r => {
          const tr = document.createElement("tr");
          const cells = [
            r.sku,
            r.title || "—",
            r.units,
            fmtUSD(r.revenue),
            fmtUSD(r.refunds),
            fmtUSD(r.fees),
            fmtUSD(r.cogsTotal),
            fmtUSD(r.grossProfit),
            (r.margin||0).toFixed(2)
          ];
          cells.forEach(val => {
            const td = document.createElement("td");
            td.textContent = val;
            tr.appendChild(td);
          });
          body.appendChild(tr);
        });
        $("#rowsCount").textContent = rows.length + " rows";
      }

      function updateKPIs(t){
        $("#kpiRevenue").textContent = fmtUSD(t.revenue);
        $("#kpiRefunds").textContent = fmtUSD(t.refunds);
        $("#kpiFees").textContent = fmtUSD(t.fees);
        $("#kpiGP").textContent = fmtUSD(t.gp);
      }

      function updateSkuFilter(){
        const sel = $("#skuSelect");
        const skus = Array.from(new Set(allLines.map(r=>r.sku))).sort();
        sel.innerHTML = '<option value="">All products</option>' + skus.map(s=>'<option>'+s+'</option>').join("");
      }

      function filteredSorted(){
        let rows = bySku.filter(r => {
          const okSku = productFilter ? r.sku === productFilter : true;
          const hay = (r.sku + " " + (r.title||"")).toLowerCase();
          const okQ = searchQ ? hay.includes(searchQ.toLowerCase()) : true;
          return okSku && okQ;
        });
        rows.sort((a,b) => {
          const av = a[sortKey], bv = b[sortKey];
          if (av < bv) return sortDir==="asc" ? -1 : 1;
          if (av > bv) return sortDir==="asc" ? 1 : -1;
          return 0;
        });
        return rows;
      }

      function update(){
        const rows = filteredSorted();
        renderTable(rows);
        updateKPIs(computeTotals(rows));
      }

      function showColumnsHint(cols){
        const need = ["order_id","purchase_date","sku","title","quantity","item_price","shipping_price","tax","refund_amount","buyer_state"];
        const opt = ["marketplace_fee","cogs"];
        const missing = need.filter(c => !(c in colsLower));
        $("#columnsHint").textContent = missing.length ? "Missing columns: " + missing.join(", ") + " (we'll still import what we can)" : "All key columns detected";
        $("#columnsHint").className = missing.length ? "warn" : "ok";
      }

      function normalizeRows(rows, feePct){
        const [head, ...rest] = rows;
        const colsLower = toLowerMap(head);
        showColumnsHint(colsLower);

        const out = [];
        rest.forEach(arr => {
          if (!arr || !arr.length) return;
          const get = name => {
            const i = colsLower[name];
            return (typeof i === "number") ? arr[i] : "";
          };
          const quantity = num(get("quantity")||1);
          const price = num(get("item_price"));
          const feeCol = get("marketplace_fee");
          const fee = feeCol !== "" ? num(feeCol) : +(price * quantity * feePct).toFixed(2);
          out.push({
            order_id: str(get("order_id")),
            purchase_date: str(get("purchase_date")),
            sku: str(get("sku")),
            title: str(get("title")),
            quantity: quantity,
            item_price: price,
            shipping_price: num(get("shipping_price")),
            tax: num(get("tax")),
            refund_amount: num(get("refund_amount")),
            buyer_state: str(get("buyer_state")),
            marketplace_fee: fee,
            cogs: num(get("cogs"))
          });
        });
        return out;
      }

      // --- CSV Upload handling ---
      $("#csvFile").addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        $("#status").textContent = "Reading " + file.name + "…";
        const reader = new FileReader();
        reader.onload = () => {
          try{
            const text = reader.result;
            const rows = parseCSV(text);
            const feePct = Number($("#feePct").value || 0.12);
            allLines = normalizeRows(rows, feePct);
            bySku = groupBySku(allLines);
            updateSkuFilter();
            update();
            $("#status").textContent = "Loaded " + file.name;
          }catch(err){
            console.error(err);
            $("#status").textContent = "Error reading file. See console.";
          }
        };
        reader.readAsText(file);
      });

      $("#feePct").addEventListener("change", () => {
        if (!allLines.length) return;
        // Recompute fees if they were estimated (we can't know which came from CSV, so recompute all estimates)
        const feePct = Number($("#feePct").value || 0.12);
        allLines = allLines.map(r => ({ ...r, marketplace_fee: +( (r.item_price||0) * (r.quantity||0) * feePct ).toFixed(2) }));
        bySku = groupBySku(allLines);
        update();
      });

      $("#skuSelect").addEventListener("change", (e) => { productFilter = e.target.value; update(); });
      $("#searchInput").addEventListener("input", (e) => { searchQ = e.target.value; update(); });
      $("#resetBtn").addEventListener("click", () => {
        $("#skuSelect").value = ""; productFilter = "";
        $("#searchInput").value = ""; searchQ = "";
        sortKey = "grossProfit"; sortDir = "desc";
        update();
      });

      $("#downloadBtn").addEventListener("click", () => {
        const rows = filteredSorted();
        const cols = ["SKU","Title","Units","Revenue","Refunds","Fees","COGS (total)","Gross Profit","Margin %"];
        const lines = [cols.join(",")].concat(rows.map(r => [
          r.sku, r.title||"", r.units,
          r.revenue.toFixed(2), r.refunds.toFixed(2), r.fees.toFixed(2),
          r.cogsTotal.toFixed(2), r.grossProfit.toFixed(2),
          (r.margin||0).toFixed(2)
        ].join(",")));
        const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = "pnl_by_sku.csv"; a.click();
        URL.revokeObjectURL(url);
      });

      // Seed with a tiny sample so the UI isn't empty
      (function seed(){
        const sample = `order_id,purchase_date,sku,title,quantity,item_price,shipping_price,tax,refund_amount,buyer_state,marketplace_fee,cogs
TGT-1001,2025-07-01,ABC-123,Widget A,2,25.00,5.00,3.00,0.00,MN,6.00,8.50
TGT-1001,2025-07-01,XYZ-999,Gadget Z,1,40.00,0.00,2.80,0.00,MN,4.80,18.00`;
        const rows = parseCSV(sample);
        allLines = normalizeRows(rows, Number($("#feePct").value || 0.12));
        bySku = groupBySku(allLines);
        updateSkuFilter();
        update();
        $("#status").textContent = "Loaded sample. Upload your CSV to replace.";
      })();
    </script>
  </body>
</html>
